name: Deploy Next.js Static to ECS

# 触发条件：推送到 main 分支时执行
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    environment: production
    runs-on: ubuntu-latest # 使用 GitHub 托管的 Linux 运行器

    steps:
      # 步骤 1：拉取 GitHub 仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2：安装 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 匹配 ECS 服务器的 Node 版本

      # 步骤 3：安装依赖并打包静态资源
      - name: Install dependencies and build
        run: |
          npm install -g pnpm # 安装 pnpm 包管理器
          pnpm install
          pnpm run build # 执行 next build，生成 out/ 目录

       # 步骤4：配置 SSH 免密登录
      - name: 配置 SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_PRIVATE_KEY }}

      # 步骤5：上传打包后的文件到服务器
      - name: 上传构建产物到服务器
        run: |
          # 确保服务器部署目录存在
          ssh -o StrictHostKeyChecking=no ${{ secrets.ECS_USERNAME }}@${{ secrets.ECS_HOST }} -p ${{ secrets.ECS_PORT }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          # 上传 dist 目录（根据项目调整，如 build、out 等）
          scp -o StrictHostKeyChecking=no -P ${{ secrets.ECS_PORT }} -r ./out/* ${{ secrets.ECS_USERNAME }}@${{ secrets.ECS_HOST }}:${{ secrets.DEPLOY_PATH }}

      # 可选步骤：执行服务器额外命令（如重启 Nginx、清理缓存）
      - name: 重启 Nginx（可选）
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ECS_USERNAME }}@${{ secrets.ECS_HOST }} -p ${{ secrets.ECS_PORT }} "systemctl restart nginx"
